# ==========================================
# STAGE 1: Backend Builder
# ==========================================
FROM python:3.12-slim-trixie AS backend-builder
WORKDIR /app

ENV PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on

RUN pip install poetry

COPY pyproject.toml poetry.lock* ./
RUN touch README.md

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á .venv ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
RUN poetry config virtualenvs.in-project true

# ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° --no-root ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏ï‡∏≠‡∏ô‡∏´‡∏≤‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
RUN poetry install --no-interaction --no-root

COPY . .

# ==========================================
# STAGE 2: Final Production Image
# ==========================================
FROM python:3.12-slim-trixie

ENV TZ=Asia/Bangkok \
    LANG=th_TH.UTF-8 \
    LANGUAGE=th_TH:en

RUN apt-get update && \
    apt-get install -y --no-install-recommends locales && \
    sed -i '/th_TH.UTF-8/s/^# //g' /etc/locale.gen && locale-gen && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get autoclean && \
    rm -rf /var/cache/apt/archives/*.deb

WORKDIR /app

# üåü ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á poetry ‡πÉ‡∏ô Stage ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á 'poetry run' ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÑ‡∏î‡πâ
RUN pip install poetry

# ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ .venv ‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Stage 1
COPY --from=backend-builder /app/.venv ./.venv
COPY . .

# üåü 1. ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
RUN chmod +x ./scripts/run-dev

# üåü 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PATH ‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà .venv
ENV PATH="/app/.venv/bin:$PATH"

EXPOSE 9000

# üåü 3. ‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå ./scripts/run-dev
CMD ["./scripts/run-dev"]